(window.odspNextWebpackJsonp=window.odspNextWebpackJsonp||[]).push([[667],{7327:function(e,t,n){"use strict";n.r(t);var a=n(0),i=n(200),r=n(300),o=n(33),s=n(5502),c=n(608),d=n(4263),l={ODB:459},u={ODB:!0},f=["Due to organizational policies, you can't access these resources from this network location","One of the provided arguments is not acceptable","Session has been revoked","The access token has expired","The caller does not have permission to perform the action","The caller is not authenticated","The request is malformed or incorrect","There has been an error authenticating the request"],p=function(){function e(e,t){this._firedConnectQoSEvent=!1,this._getSubscriptionAttempts=0,this._socketIoReconnectAttempts=0,this._notificationHandlers={},this._connectionHandlers={},this._disableWebSockets=e.disableWebSockets,this._subscriptionService=t.subscriptionService,this._sessionTokenFetcher=t.sessionTokenFetcher,this._async=new i.e,this._socketIoReconnectAttempts=0}return e.prototype.isConnected=function(){return!!this._socketIo&&this._socketIo.connected},e.prototype.getSocketIoSubscription=function(){return this._subscription},e.prototype.addConnectionHandler=function(e,t){this._connectionHandlers[e]=t},e.prototype.removeConnectionHandler=function(e){delete this._connectionHandlers[e]},e.prototype.setupNotificationHandler=function(e,t){var n=e.source,a=e.scenarios,i=e.id,r=void 0===i?"":i,o=s.t[n];if(o){if(a&&a.length)for(var c=0,d=a;c<d.length;c++){var l=d[c];this._notificationHandlers[o.toLowerCase()+s.e[l].toLowerCase()+r]=t}else this._notificationHandlers[o.toLowerCase()+r]=t;return!0}return!1},e.prototype.connect=function(e,t){return Object(a.__awaiter)(this,void 0,void 0,function(){var n,i,c,l,f=this;return Object(a.__generator)(this,function(p){switch(p.label){case 0:return this.disconnect(),void 0!==e?[3,2]:(n=this,[4,this._getSubscription("PushChannelService.Connect")]);case 1:return n._subscription=p.sent(),[3,3];case 2:this._subscription=e,p.label=3;case 3:return this._log("Connecting to subscription",this._subscription),void 0===this._subscription?(this._log("Invalid subscription"),[2,!1]):(this._firedConnectQoSEvent&&!r.e.isFeatureEnabled(u)||(this._firedConnectQoSEvent=!0,i=new o.e({name:"PushChannelService.Connect",extraData:Object(a.__assign)({notificationUrl:this._subscription.notificationUrl},t||{})})),c={reconnectionAttempts:20},-1!==this._subscription.notificationUrl.indexOf("pushn")?c.transports=["websocket"]:this._disableWebSockets&&(c.transports=["polling"]),l=this._socketIo=d.connect(this._subscription.notificationUrl,c),this._socketIo.on("connect",function(){var e;l===f._socketIo?(f._log("Connected"),i&&i.end({resultType:o.t.Success,extraData:Object(a.__assign)({notificationUrl:null===(e=f._subscription)||void 0===e?void 0:e.notificationUrl},t||{})}),f._executeConnectionHandlers(!0)):l.disconnect()}),this._socketIo.on("disconnect",function(){l===f._socketIo&&(f._log("Disconnected"),f._executeConnectionHandlers(!1))}),this._socketIo.on("reconnect_failed",function(){var e,n;f._log("Reconnect failed"),i&&i.end({resultType:o.t.Failure,extraData:Object(a.__assign)({notificationUrl:null===(e=f._subscription)||void 0===e?void 0:e.notificationUrl},t||{})}),f._subscription=void 0,f._socketIoReconnectAttempts++,f._socketIoReconnectAttempts>3?f._log("Exceeded max reconnect attempts"):null===(n=f._async)||void 0===n||n.setTimeout(function(){f.connect(void 0,{methodInvoker:"reconnect_failed"})},0)}),this._socketIo.on("notification",function(e){var t;f._log("Notification",e);try{t=JSON.parse(e)}catch(e){return}var n=t.source,a=t.scenario?t.scenario.toLowerCase():"";n||(n=s.t[s.t.WebhookSubscription]),n=n.toLowerCase();var i=!1;i=f._handleMessage(t,n);var r=n+a;for(var o in f._notificationHandlers)-1!==o.indexOf(r)&&o!==n&&(i=f._handleMessage(t,o,r)||i);i||f._log("Notification - missing handler for message")}),[2,!0])}})})},e.prototype.disconnect=function(){this._socketIo&&(this._socketIo.disconnect(),this._socketIo=void 0),this._async&&(this._async.dispose(),this._async=new i.e),this._subscription=void 0},e.prototype.refreshSubscription=function(){return Object(a.__awaiter)(this,void 0,void 0,function(){var e;return Object(a.__generator)(this,function(t){switch(t.label){case 0:return[4,this._getSubscription("PushChannelService.refreshSubscription")];case 1:return void 0===(e=t.sent())?[2,void 0]:this.isConnected()&&this._subscription&&this._subscription.notificationUrl!==e.notificationUrl?(this._log("Notification url changed. Reconnecting..."),this.connect(e,{methodInvoker:"PushChannelService.refreshSubscription"}),[2,!1]):(this._subscription=e,[2,!0])}})})},e.prototype._getSubscription=function(e){var t;return void 0===e&&(e="unknown"),Object(a.__awaiter)(this,void 0,void 0,function(){var n,i,s,d,u,p,m,_,h,b,g=this;return Object(a.__generator)(this,function(a){switch(a.label){case 0:i=void 0,r.e.isFeatureEnabled(l)&&(i=new o.e({name:"PushChannelService.getSubscription",extraData:{methodInvoker:e,getSubscriptionAttempts:this._getSubscriptionAttempts,socketIoReconnectAttempts:this._socketIoReconnectAttempts}})),a.label=1;case 1:return a.trys.push([1,6,,7]),d=(s=this._subscriptionService).getSocketIoSubscription,b={},this._sessionTokenFetcher?[4,this._sessionTokenFetcher()]:[3,3];case 2:return u=a.sent(),[3,4];case 3:u=void 0,a.label=4;case 4:return[4,d.apply(s,[(b.sessionToken=u,b.existingSubscription=this._subscription,b)])];case 5:return n=a.sent(),i&&i.end({resultType:o.t.Success,extraData:{methodInvoker:e,getSubscriptionAttempts:this._getSubscriptionAttempts,socketIoReconnectAttempts:this._socketIoReconnectAttempts}}),[3,7];case 6:return p=a.sent(),this._log("Failed to get socketIo subscription",p),m=!1,_=0,Object(c.r)(p)&&(403===p.status?m=!0:p.error&&p.error.message&&(m=f.some(function(e){return 0===p.error.message.indexOf(e)})),(h=null===(t=p.request)||void 0===t?void 0:t.getResponseHeader("Retry-After"))&&(_=Number(h),isNaN(_)&&(_=0))),i&&i.end({resultType:o.t.Success,extraData:{methodInvoker:e,getSubscriptionAttempts:this._getSubscriptionAttempts,socketIoReconnectAttempts:this._socketIoReconnectAttempts,retryAfterSeconds:_}}),m?[2,void 0]:(this._getSubscriptionAttempts++,this._getSubscriptionAttempts>10?[2,void 0]:[2,new Promise(function(e){var t,n=Math.max(1e3*_,3e4*Math.pow(2,g._getSubscriptionAttempts));g._log("Retrying in ".concat(n," milliseconds")),null===(t=g._async)||void 0===t||t.setTimeout(function(){return e(g._getSubscription("Retry_getSubscription"))},n)})]);case 7:return[2,n]}})})},e.prototype._handleMessage=function(e,t,n){void 0===n&&(n=t);var a=this._notificationHandlers[t];return!!a&&(a(e.payload?e.payload:e.value),!0)},e.prototype._executeConnectionHandlers=function(e){for(var t=0,n=Object.keys(this._connectionHandlers);t<n.length;t++){var a=n[t];this._connectionHandlers[a](e)}},e.prototype._log=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]},e}();t.default=p}}]);